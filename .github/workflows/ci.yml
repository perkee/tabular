name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Cache Elm artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.elm
            elm-stuff
            review/elm-stuff
          key: elm-${{ hashFiles('elm.json', 'review/elm.json') }}
          restore-keys: elm-

      - name: Cache lamdera binary
        id: cache-lamdera
        uses: actions/cache@v4
        with:
          path: /usr/local/bin/lamdera
          key: lamdera-1.3.0-linux-x86_64

      - name: Install lamdera
        if: steps.cache-lamdera.outputs.cache-hit != 'true'
        run: |
          curl -sSL https://static.lamdera.com/bin/lamdera-1.3.0-linux-x86_64 -o /usr/local/bin/lamdera
          chmod +x /usr/local/bin/lamdera

      - name: Install dependencies
        run: npm ci

      - name: Set up SSH for Lamdera
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.LAMDERA_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -t ed25519 apps.lamdera.com >> ~/.ssh/known_hosts 2>/dev/null

      - name: Add lamdera remote
        run: git remote add lamdera git@apps.lamdera.com:tabular.git

      - name: Build
        run: npm run build

      - name: Test
        run: npm test

      - name: Review
        run: npm run review

      - name: Lamdera check
        run: |
          printf '%s' "${{ secrets.LAMDERA_TOKEN }}" > ~/.elm/.lamdera-cli
          lamdera check

  deploy:
    needs: check
    runs-on: ubuntu-latest
    outputs:
      preview-url: ${{ steps.set-url.outputs.preview-url }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up SSH for Lamdera
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.LAMDERA_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -t ed25519 apps.lamdera.com >> ~/.ssh/known_hosts 2>/dev/null

      - name: Add lamdera remote
        run: git remote add lamdera git@apps.lamdera.com:tabular.git

      - name: Checkout PR head branch
        if: github.event_name == 'pull_request'
        run: git checkout "${{ github.head_ref }}"

      - name: Deploy
        id: set-url
        run: |
          set +e
          OUTPUT=$(git push lamdera HEAD -f 2>&1)
          EXIT_CODE=$?
          set -e
          echo "$OUTPUT"
          if [ $EXIT_CODE -ne 0 ]; then
            exit $EXIT_CODE
          fi
          SLUG=$(echo "$OUTPUT" | sed 's/\x1b\[[0-9;]*m//g' | sed -n 's/.*Starting preview deploy for `\([^`]*\)`.*/\1/p')
          if [ -n "$SLUG" ]; then
            echo "preview-url=https://${SLUG}.lamdera.app" >> "$GITHUB_OUTPUT"
          fi

  e2e:
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Cache Elm artifacts
        if: github.event_name == 'push'
        uses: actions/cache@v4
        with:
          path: |
            ~/.elm
            elm-stuff
          key: elm-${{ hashFiles('elm.json') }}
          restore-keys: elm-

      - name: Cache lamdera binary
        if: github.event_name == 'push'
        id: cache-lamdera
        uses: actions/cache@v4
        with:
          path: /usr/local/bin/lamdera
          key: lamdera-1.3.0-linux-x86_64

      - name: Install lamdera
        if: github.event_name == 'push' && steps.cache-lamdera.outputs.cache-hit != 'true'
        run: |
          curl -sSL https://static.lamdera.com/bin/lamdera-1.3.0-linux-x86_64 -o /usr/local/bin/lamdera
          chmod +x /usr/local/bin/lamdera

      - name: Install dependencies
        run: npm ci

      - name: Build
        if: github.event_name == 'push'
        run: npm run build

      - name: Cache Playwright browsers
        id: cache-playwright
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ hashFiles('package-lock.json') }}

      - name: Install Playwright browsers
        if: steps.cache-playwright.outputs.cache-hit != 'true'
        run: npx playwright install chromium

      - name: Install Playwright system deps
        run: npx playwright install-deps chromium

      - name: Wait for preview deployment
        if: github.event_name == 'pull_request'
        env:
          PREVIEW_URL: ${{ needs.deploy.outputs.preview-url }}
        run: |
          echo "Waiting for $PREVIEW_URL to become available..."
          for i in $(seq 1 30); do
            if curl -sSf "$PREVIEW_URL" > /dev/null 2>&1; then
              echo "Preview is up!"
              exit 0
            fi
            echo "Attempt $i/30 â€” not ready yet, waiting 10s..."
            sleep 10
          done
          echo "Preview did not become available in time"
          exit 1

      - name: Run E2E tests (preview)
        if: github.event_name == 'pull_request'
        env:
          BASE_URL: ${{ needs.deploy.outputs.preview-url }}
        run: npx playwright test

      - name: Run E2E tests (local)
        if: github.event_name == 'push'
        run: npx playwright test

      - name: Upload Playwright report
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 14

  comment-preview:
    needs: deploy
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Comment preview URL on PR
        uses: actions/github-script@v7
        with:
          script: |
            const previewUrl = '${{ needs.deploy.outputs.preview-url }}';
            const marker = '<!-- lamdera-preview -->';
            const body = `${marker}\n**Preview deployment:** ${previewUrl}`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existing = comments.find(c => c.body.includes(marker));
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }
